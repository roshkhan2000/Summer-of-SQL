-- 6. What is the number and percentage of customer plans after their initial free trial?
WITH CTE_next_plan AS (
    SELECT p.plan_name
            , p.price
            , s.customer_id
            , s.plan_id
            , s.start_date
            , LEAD(plan_name, 1) OVER(PARTITION BY customer_id ORDER BY start_date ASC) AS next_plan
    FROM plans AS p
    LEFT JOIN subscriptions AS S
    ON p.plan_id = s.plan_id
    ORDER BY 
        CUSTOMER_ID ASC
        , start_date ASC
)

SELECT next_plan
    , count(next_plan) AS count_of_plans
    , ROUND( ( count(next_plan) / (SELECT count(next_plan) FROM CTE_next_plan WHERE plan_name= 'trial') ) * 100, 1) AS percentage_of_plans
FROM CTE_next_plan AS c
WHERE plan_name = 'trial'
GROUP BY next_plan;
