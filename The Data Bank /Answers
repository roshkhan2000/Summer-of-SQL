-- A. Customer Nodes Exploration
-- How many unique nodes are there on the Data Bank system?
-- What is the number of nodes per region?
-- How many customers are allocated to each region?
-- How many days on average are customers reallocated to a different node?
-- What is the median, 80th and 95th percentile for this same reallocation days metric for each region?

-- How many unique nodes are there on the Data Bank system
SELECT COUNT(DISTINCT node_id) as distinct_nodes
FROM customer_nodes;

-- What is the number of nodes per region?
SELECT r.region_name
    , COUNT(DISTINCT n.node_id) AS no_of_nodes
FROM customer_nodes AS n
LEFT JOIN regions AS r
ON n.region_id = r.region_id
GROUP BY r.region_name;

-- How many customers are allocated to each region?
SELECT r.region_name
    , COUNT( DISTINCT n.customer_id) AS no_of_customers
FROM customer_nodes AS n
LEFT JOIN regions AS r
ON n.region_id = r.region_id
GROUP BY r.region_name;

-- How many days on average are customers reallocated to a different node?
WITH days_in_node AS (
    SELECT 
        customer_id,
        node_id,
        SUM(DATEDIFF('days',start_date,end_date)) AS days_in_node
    FROM customer_nodes
    WHERE end_date <> '9999-12-31'
    GROUP BY customer_id,
    node_id
)

SELECT 
ROUND(AVG(days_in_node),0) AS average_days_in_node
FROM days_in_node;

-- What is the median, 80th and 95th percentile for this same reallocation days metric for each region?
